{% extends "base.html" %}

{% block title %}AI Pricing Insights{% endblock %}

{% block extra_head %}
<style>
    .container {
        max-width: 960px;
        margin: 32px auto;
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
        margin-top: 0;
        font-size: 24px;
    }
    form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px 24px;
        margin-bottom: 24px;
    }
    fieldset {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px 16px;
    }
    legend {
        font-weight: bold;
        padding: 0 4px;
    }
    label {
        display: block;
        font-size: 14px;
        margin-bottom: 4px;
        margin-top: 8px;
    }
    input[type="number"],
    input[type="file"],
    select {
        width: 100%;
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
    }
    .full-width {
        grid-column: 1 / -1;
    }
    button {
        margin-top: 12px;
        padding: 10px 18px;
        background-color: #0070f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    button:hover {
        background-color: #0059c1;
    }
    .results {
        margin-top: 24px;
        border-top: 1px solid #e0e0e0;
        padding-top: 16px;
    }
    .highlight {
        background: #f0f7ff;
        border: 1px solid #c9e1ff;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 6px 8px;
        font-size: 14px;
        text-align: right;
    }
    th {
        background: #f7f7f7;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>AI Pricing Insights</h1>
    <p class="hint">
        Select a product, upload sales history (optional), and enter cost parameters to see cost-plus and AI-based pricing suggestions.
    </p>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="full-width">
            <label for="product_code">Product Code</label>
            <select id="product_code" name="product_code" required>
                <option value="">Select a product</option>
                {% for code in product_codes %}
                    <option value="{{ code }}" {% if selected_product_code == code %}selected{% endif %}>
                        {{ code }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <fieldset>
            <legend>Manufacturing</legend>
            <label for="smd_cost_per_component">SMD Cost per Component (IRR)</label>
            <input type="number" id="smd_cost_per_component" name="smd_cost_per_component" step="1"
                   value="{{ form_values.smd_cost_per_component }}" required>

            <label for="tht_cost_per_component">THT Cost per Component (IRR)</label>
            <input type="number" id="tht_cost_per_component" name="tht_cost_per_component" step="1"
                   value="{{ form_values.tht_cost_per_component|default:0 }}" required>

            <label for="assembly_time_min">Assembly Time (min)</label>
            <input type="number" id="assembly_time_min" name="assembly_time_min" step="0.1"
                   value="{{ form_values.assembly_time_min }}" required>

            <label for="qc_test_time_min">QC Test Time (min)</label>
            <input type="number" id="qc_test_time_min" name="qc_test_time_min" step="0.1"
                   value="{{ form_values.qc_test_time_min }}" required>

            <label for="worker_hour_cost">Worker Hour Cost (IRR)</label>
            <input type="number" id="worker_hour_cost" name="worker_hour_cost" step="1"
                   value="{{ form_values.worker_hour_cost }}" required>
        </fieldset>

        <fieldset>
            <legend>Logistics</legend>
            <label for="shipping_cost_usd">Shipping Cost (USD)</label>
            <input type="number" id="shipping_cost_usd" name="shipping_cost_usd" step="0.1"
                   value="{{ form_values.shipping_cost_usd }}" required>

            <label for="custom_clearance_irr">Custom Clearance (IRR)</label>
            <input type="number" id="custom_clearance_irr" name="custom_clearance_irr" step="1"
                   value="{{ form_values.custom_clearance_irr }}" required>

            <label for="duty_percent">Duty Percent (%)</label>
            <input type="number" id="duty_percent" name="duty_percent" step="0.1"
                   value="{{ form_values.duty_percent }}" required>

            <label for="exchange_rate_buy">Exchange Rate Buy (IRR)</label>
            <input type="number" id="exchange_rate_buy" name="exchange_rate_buy" step="1"
                   value="{{ form_values.exchange_rate_buy }}" required>
        </fieldset>

        <fieldset>
            <legend>Inventory</legend>
            <label for="inventory_days">Inventory Days</label>
            <input type="number" id="inventory_days" name="inventory_days" step="1"
                   value="{{ form_values.inventory_days }}" required>

            <label for="capital_cost_rate">Capital Cost Rate (% per year)</label>
            <input type="number" id="capital_cost_rate" name="capital_cost_rate" step="0.1"
                   value="{{ form_values.capital_cost_rate }}" required>
        </fieldset>

        <fieldset>
            <legend>Market & Finance</legend>
            <label for="competitor_price_avg">Competitor Price Avg (IRR)</label>
            <input type="number" id="competitor_price_avg" name="competitor_price_avg" step="1"
                   value="{{ form_values.competitor_price_avg|default:0 }}">

            <label for="exchange_rate_now">Exchange Rate Now (IRR)</label>
            <input type="number" id="exchange_rate_now" name="exchange_rate_now" step="1"
                   value="{{ form_values.exchange_rate_now }}" required>

            <label for="target_margin_percent">Target Margin (%)</label>
            <input type="number" id="target_margin_percent" name="target_margin_percent" step="0.1"
                   value="{{ form_values.target_margin_percent }}" required>
        </fieldset>

        <fieldset class="full-width">
            <legend>Sales History (Optional)</legend>
            <label for="sales_file">Sales CSV (month,product_code,price,units_sold)</label>
            <input type="file" id="sales_file" name="sales_file" accept=".csv">
        </fieldset>

        <div class="full-width">
            <button type="submit">Compute AI Insights</button>
        </div>
    </form>

    {% if cost_breakdown %}
    <div class="results">
        <div class="highlight">
            <strong>Cost-plus price:</strong>
            {{ recommended_price|floatformat:0 }} IRR<br>
            {% if final_suggested_price %}
                <strong>Final suggested price (blended):</strong>
                {{ final_suggested_price|floatformat:0 }} IRR
            {% endif %}
        </div>

        <h2>Cost Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Cost (IRR)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>BOM Cost</td><td>{{ cost_breakdown.bom_cost_irr|floatformat:0 }}</td></tr>
                <tr><td>Assembly Cost</td><td>{{ cost_breakdown.assembly_cost_irr|floatformat:0 }}</td></tr>
                <tr><td>Labor Cost</td><td>{{ cost_breakdown.labor_cost_irr|floatformat:0 }}</td></tr>
                <tr><td>Logistics Cost</td><td>{{ cost_breakdown.logistics_cost_irr|floatformat:0 }}</td></tr>
                <tr><td>Inventory Cost</td><td>{{ cost_breakdown.inventory_cost_irr|floatformat:0 }}</td></tr>
                <tr><th>Total</th><th>{{ cost_breakdown.total_cost_irr|floatformat:0 }}</th></tr>
            </tbody>
        </table>

        {% if elasticity_result %}
            <h2>Elasticity & ML Optimal Price</h2>
            {% if elasticity_result.all_negative %}
                <p><strong>Warning:</strong> ML found no profitable price in the observed range.</p>
            {% endif %}
            <p>
                Elasticity: <strong>{{ elasticity_result.elasticity|floatformat:2 }}</strong><br>
                ML Optimal Price: <strong>{{ elasticity_result.optimal_price|floatformat:0 }}</strong> IRR<br>
                Max Profit (approx): <strong>{{ elasticity_result.max_profit|floatformat:0 }}</strong> IRR
            </p>

            {% if price_grid and profit_grid %}
                <h3>Profit Curve (Price vs Profit)</h3>
                <canvas id="profitChart" width="600" height="300"></canvas>
                <script>
                    const priceData = {{ price_grid|safe }};
                    const profitData = {{ profit_grid|safe }};

                    const canvas = document.getElementById('profitChart');
                    const ctx = canvas.getContext('2d');

                    // Chart padding
                    const padLeft = 50;
                    const padRight = 20;
                    const padTop = 20;
                    const padBottom = 40;

                    const W = canvas.width;
                    const H = canvas.height;

                    const minPrice = Math.min(...priceData);
                    const maxPrice = Math.max(...priceData);
                    const maxProfit = Math.max(...profitData);
                    const minProfit = Math.min(...profitData);

                    // Mapping functions
                    function xScale(p) {
                        return padLeft + (p - minPrice) / (maxPrice - minPrice) * (W - padLeft - padRight);
                    }

                    function yScale(v) {
                        // Higher profit should be higher on canvas â†’ invert Y
                        return H - padBottom - (v - minProfit) / (maxProfit - minProfit) * (H - padTop - padBottom);
                    }

                    // Clear canvas
                    ctx.clearRect(0, 0, W, H);

                    // Draw axes
                    ctx.strokeStyle = "#444";
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(padLeft, padTop);
                    ctx.lineTo(padLeft, H - padBottom);
                    ctx.lineTo(W - padRight, H - padBottom);
                    ctx.stroke();

                    // Draw profit curve
                    ctx.strokeStyle = "#0070f3";
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = 0; i < priceData.length; i++) {
                        const x = xScale(priceData[i]);
                        const y = yScale(profitData[i]);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();

                    // Mark optimal point
                    const maxIdx = profitData.indexOf(Math.max(...profitData));
                    const optX = xScale(priceData[maxIdx]);
                    const optY = yScale(profitData[maxIdx]);

                    ctx.fillStyle = "#ff0000";
                    ctx.beginPath();
                    ctx.arc(optX, optY, 5, 0, Math.PI * 2);
                    ctx.fill();

                    // Labels
                    ctx.fillStyle = "#000";
                    ctx.font = "12px sans-serif";
                    ctx.fillText("Price (IRR)", W / 2 - 30, H - 10);

                    ctx.save();
                    ctx.translate(15, H / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText("Profit (IRR)", 0, 0);
                    ctx.restore();
                </script>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
